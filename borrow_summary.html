<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สรุปการยืมเครื่องดนตรี - สาขาดนตรีสากลศึกษา 2568</title>
    <style>
        /* สไตล์ที่ปรับให้เข้ากับหน้า 2 */
        body {
            font-family: 'Inter', Arial, sans-serif; /* ใช้ฟอนต์ Inter */
            background-color: #f4f7f6; /* สีพื้นหลังอ่อนๆ เหมือนหน้า 2 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* ทำให้หน้าเว็บเต็มความสูงของ viewport */
            margin: 0;
            padding: 20px; /* เพิ่ม padding รอบๆ */
            box-sizing: border-box;
        }
        /* สไตล์สำหรับ container หลัก */
        .container {
            background-color: #ffffff; /* สีพื้นหลังของกล่อง เหมือนหน้า 2 */
            padding: 40px; /* padding ภายในกล่อง */
            border-radius: 12px; /* ขอบโค้งมน */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); /* เงาเพื่อความลึก */
            width: 100%;
            max-width: 700px; /* กำหนดความกว้างสูงสุด */
            box-sizing: border-box;
        }
        /* สไตล์สำหรับหัวข้อ */
        h1 {
            text-align: center;
            color: #2c3e50; /* สีข้อความหัวข้อ เหมือนหน้า 2 */
            margin-bottom: 30px;
            font-size: 1.8em;
            font-weight: 700;
        }
        h2 {
            color: #34495e; /* สีข้อความหัวข้อรอง คล้าย label ในหน้า 2 */
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.4em;
            border-bottom: 1px solid #eceff1; /* เส้นแบ่งเหมือนหน้า 2 */
            padding-bottom: 5px;
        }
        /* สไตล์สำหรับกล่องแสดงข้อมูลผู้ยืม */
        #userInfoSummary {
            background-color: #f8f8f8; /* สีพื้นหลังอ่อนๆ คล้าย body */
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            font-size: 0.95em;
            color: #34495e; /* สีข้อความเหมือน label */
            border: 1px solid #ced4da; /* ขอบเหมือน input ในหน้า 2 */
        }
        #userInfoSummary p {
            margin: 8px 0; /* ระยะห่างระหว่างบรรทัดข้อมูล */
        }
        #userInfoSummary strong {
            color: #2c3e50; /* สีตัวหนา เหมือน h1 */
        }

        /* สไตล์สำหรับรายการอุปกรณ์ที่ยืม */
        #borrowedItemsList {
            list-style: none; /* ไม่มี bullet point */
            padding: 0;
            margin: 0;
            border: 1px solid #ced4da; /* ขอบเหมือน input ในหน้า 2 */
            border-radius: 8px;
            overflow: hidden; /* เพื่อให้ border-radius ทำงานกับ li ตัวแรก/สุดท้าย */
        }
        #borrowedItemsList li {
            padding: 15px 20px;
            border-bottom: 1px solid #eceff1; /* เส้นแบ่งเหมือนหน้า 2 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #ffffff; /* สีพื้นหลังรายการ */
        }
        #borrowedItemsList li:last-child {
            border-bottom: none; /* ไม่มีเส้นแบ่งที่รายการสุดท้าย */
        }
        #borrowedItemsList li span:first-child {
            font-weight: 600;
            color: #34495e; /* สีข้อความชื่ออุปกรณ์ เหมือน label */
        }
        #borrowedItemsList li span:last-child {
            color: #2c3e50; /* สีข้อความจำนวน เหมือน h1 */
            font-weight: 700;
        }
        /* สไตล์สำหรับข้อความเมื่อไม่มีรายการ */
        #noItemsMessage {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
            background-color: #f8f8f8; /* สีพื้นหลังเหมือน userInfoSummary */
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #ced4da;
        }

        /* สไตล์สำหรับปุ่ม */
        .main-button {
            background-color: #007bff; /* สีน้ำเงิน เหมือนปุ่มหลักหน้า 2 */
            color: white; /* สีข้อความปุ่ม */
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            width: 100%;
            margin-top: 30px; /* ระยะห่างด้านบน */
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 700;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* เพิ่มเงาปุ่ม */
        }
        .main-button:hover {
            background-color: #0056b3; /* สีเข้มขึ้นตอน hover เหมือนหน้า 2 */
            transform: translateY(-2px);
        }
        .main-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .back-button {
            background-color: #6c757d; /* สีเทา */
            margin-top: 15px;
        }
        .back-button:hover {
            background-color: #5a6268;
        }
        .proof-button {
            background-color: #17a2b8; /* สีฟ้า เหมือนปุ่มเพิ่มหน้า 2 */
            margin-top: 15px;
        }
        .proof-button:hover {
            background-color: #138496;
        }
    </style>
</head>
<body class="flex justify-center items-center min-h-screen p-5">
    <div class="container">
        <h1 class="text-center text-4xl font-bold mb-8">สรุปการยืมเครื่องดนตรี</h1>
        
        <!-- Section to display borrower information -->
        <div id="userInfoSummary">
            <p class="mb-2"><strong>ชื่อ-สกุล:</strong> <span id="summaryFullName"></span></p>
            <p class="mb-2"><strong>เบอร์โทรศัพท์:</strong> <span id="summaryPhoneNumber"></span></p>
            <p class="mb-2"><strong>Email:</strong> <span id="summaryEmail"></span></p>
            <p class="mb-2"><strong>วันที่ยืม:</strong> <span id="summaryBorrowDate"></span></p>
            <p class="mb-2"><strong>วันที่คืน:</strong> <span id="summaryReturnDate"></span></p>
            <p class="mb-0"><strong>เหตุผล:</strong> <span id="summaryReason"></span></p>
        </div>

        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">รายการอุปกรณ์ที่เลือกยืม:</h2>
        <ul id="borrowedItemsList">
            <!-- Equipment list will be added with JavaScript -->
        </ul>
        <p id="noItemsMessage" style="display: none;">ยังไม่มีอุปกรณ์ที่เลือกยืม</p>

        <div class="mt-8 space-y-4">
            <button type="button" id="confirmAllButton" class="main-button">ยืนยันการยืมทั้งหมด</button>
            <button type="button" id="backButton" class="main-button back-button">ย้อนกลับไปเลือกอุปกรณ์</button>
            <button type="button" id="borrowProofButton" class="main-button proof-button">หลักฐานการยืม</button>
        </div>
    </div>

    <script>
        // When the web page finishes loading
        document.addEventListener('DOMContentLoaded', function() {
            // Retrieve borrower information from sessionStorage
            let borrowerInfo = null;
            try {
                borrowerInfo = JSON.parse(sessionStorage.getItem('borrowerInfo'));
            } catch (e) {
                console.error("Error parsing borrowerInfo from sessionStorage:", e);
                // Optionally clear the corrupted item to prevent future errors
                sessionStorage.removeItem('borrowerInfo');
            }

            // Retrieve borrowed items list from sessionStorage
            let borrowedItems = [];
            try {
                borrowedItems = JSON.parse(sessionStorage.getItem('borrowedItems')) || [];
            } catch (e) {
                console.error("Error parsing borrowedItems from sessionStorage:", e);
                // Optionally clear the corrupted item and ensure borrowedItems is an empty array
                sessionStorage.removeItem('borrowedItems');
                borrowedItems = [];
            }

            // Display borrower information
            if (borrowerInfo) {
                document.getElementById('summaryFullName').textContent = borrowerInfo.firstName + ' ' + borrowerInfo.lastName;
                document.getElementById('summaryPhoneNumber').textContent = borrowerInfo.phoneNumber;
                document.getElementById('summaryEmail').textContent = borrowerInfo.email;
                document.getElementById('summaryBorrowDate').textContent = borrowerInfo.borrowDate;
                document.getElementById('summaryReturnDate').textContent = borrowerInfo.returnDate;
                document.getElementById('summaryReason').textContent = borrowerInfo.reason;
            } else {
                // If no borrower information is found (e.g., accessed this page directly)
                document.getElementById('userInfoSummary').innerHTML = '<p class="text-center" style="color: #dc3545;">ไม่พบข้อมูลผู้ยืม กรุณากลับไปหน้าแรกเพื่อกรอกข้อมูล</p>';
            }

            // Display selected borrowed items
            const borrowedItemsList = document.getElementById('borrowedItemsList');
            const noItemsMessage = document.getElementById('noItemsMessage');

            if (borrowedItems.length > 0) {
                borrowedItems.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = 'p-4 flex justify-between items-center';
                    listItem.style.backgroundColor = '#fdfdfd'; /* Off-white for list items */
                    listItem.innerHTML = `<span class="font-semibold">${item.name}</span><span class="font-bold">จำนวน: ${item.quantity}</span>`;
                    borrowedItemsList.appendChild(listItem);
                });
                noItemsMessage.style.display = 'none'; // Hide no items message
            } else {
                noItemsMessage.style.display = 'block'; // Show no items message
            }

            // "Confirm All Borrow" button
            document.getElementById('confirmAllButton').addEventListener('click', function() {
                if (borrowedItems.length === 0) {
                    alert('ยังไม่มีอุปกรณ์ที่เลือกยืม กรุณากลับไปเลือกอุปกรณ์ก่อนยืนยัน');
                    return;
                }

                // In a real application: Send borrowerInfo and borrowedItems to the Backend
                console.log("ยืนยันการยืมทั้งหมดแล้ว!");
                console.log("ข้อมูลผู้ยืม:", borrowerInfo);
                console.log("อุปกรณ์ที่ยืม:", borrowedItems);

                alert("การยืมเครื่องดนตรีได้รับการยืนยันแล้ว! (ข้อมูลถูกแสดงใน Console ของ Browser)");

                // After confirmation, clear sessionStorage to start a new process
                sessionStorage.removeItem('borrowerInfo');
                sessionStorage.removeItem('borrowedItems');
                
                // May redirect to a success page or back to the first page
                // window.location.href = 'thank_you.html'; 
                // or
                // window.location.href = 'index.html'; 
            });

            // "Back to Select Equipment" button
            document.getElementById('backButton').addEventListener('click', function() {
                window.location.href = 'borrow_equipment.html';
            });

            // "Borrow Proof" button
            document.getElementById('borrowProofButton').addEventListener('click', function() {
                if (!borrowerInfo || borrowedItems.length === 0) {
                    alert('ไม่สามารถสร้างหลักฐานการยืมได้ เนื่องจากไม่มีข้อมูลผู้ยืมหรืออุปกรณ์ที่เลือกยืม');
                    return;
                }

                // Construct the proof content
                let proofContent = "--- หลักฐานการยืมเครื่องดนตรี ---\n\n";
                proofContent += "ข้อมูลผู้ยืม:\n";
                proofContent += `  ชื่อ-สกุล: ${borrowerInfo.firstName} ${borrowerInfo.lastName}\n`;
                proofContent += `  เบอร์โทรศัพท์: ${borrowerInfo.phoneNumber}\n`;
                proofContent += `  Email: ${borrowerInfo.email}\n`;
                proofContent += `  วันที่ยืม: ${borrowerInfo.borrowDate}\n`;
                proofContent += `  วันที่คืน: ${borrowerInfo.returnDate}\n`;
                proofContent += `  เหตุผลที่ยืม: ${borrowerInfo.reason}\n\n`;

                proofContent += "รายการอุปกรณ์ที่ยืม:\n";
                if (borrowedItems.length > 0) {
                    borrowedItems.forEach(item => {
                        proofContent += `  - ${item.name}: จำนวน ${item.quantity}\n`;
                    });
                } else {
                    proofContent += "  (ไม่มีอุปกรณ์ที่เลือกยืม)\n";
                }
                proofContent += "\n--- สิ้นสุดหลักฐาน ---";

                // Create a Blob from the content
                const blob = new Blob([proofContent], { type: 'text/plain;charset=utf-8' });
                
                // Create a download link
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `หลักฐานการยืม_${borrowerInfo.firstName}_${borrowerInfo.lastName}.txt`;
                
                // Append to body and trigger click
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);

                alert("ดาวน์โหลดหลักฐานการยืมเรียบร้อยแล้ว!");
                console.log("หลักฐานการยืมถูกสร้างและดาวน์โหลดแล้ว");
            });
        });
    </script>
</body>
</html>
